---
title: "Exploring COVID Data"
author: "Sara Colom"
date: "12/8/2020"
output: github_document
---

# Goals:

Prepare a report on current COVID cases and make cool maps showing COVID cases.


1. Load libraries
2. Read in data from the covidtracking API and from project directory.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load libraries

library(tidyverse)
library(httr)
library(jsonlite)
library(leaflet)
library(lubridate)
library(gganimate)



# memory.limit(size=28000)

# Make a GET request to the COVID API

data <- read.csv("https://api.covidtracking.com/v1/states/current.csv")

info <- read.csv("../Data/states_info.csv")


current_date <- Sys.Date()
```


# Explore data

```{r, warning = F, message = F}
head(data)
```


# Compare positive cases and hospitalized currently.

```{r, warning = F, message = F}
pos_hos <- data %>% 
  select(positive, hospitalizedCurrently) %>% 
  gather() %>% 
  mutate(state = rep(data %>% pull(state), times = 2))

pos_hos <- pos_hos %>% 
  mutate(key = recode(key,
                           hospitalizedCurrently = "Currently Hospitalized",
                            positive = "Positive"))
```



```{r, warning = F, message = F, fig.width = 10, fig.height = 8}
ggplot(pos_hos %>% 
         filter(state != "AS"), aes(state, log(value), fill = key)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.9) +
  scale_fill_manual("Case status", values = c("blue", "gold")) +
  xlab("States and Territories") +
  ylab("Case Numbers (Log-Fold )") +
  ggtitle("COVID-19 Cases in the United States") +
  labs(caption = paste("Data source: https://covidtracking.com/data/api\nNumber of COVID-19 cases between states and U.S. territories.\nAmerican Samoa was excluded due to no data.\nNote: Y-axis case count is log-transformed.\nData Accessed & Plot created:",current_date)) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.25, size = 12),
        axis.text.y = element_text(size = 12),
        plot.title = element_text(hjust = 0.5, size = 20),
         plot.caption = element_text(hjust = 0, size = 8)) +
  theme(legend.position = "top")
```

COVID Deaths total between states and territories.

```{r, warning = F, message = F, fig.width = 10, fig.height = 8}
ggplot(data %>% 
         filter(!is.na(state)) %>% 
         filter(deathConfirmed != 0), aes(state, deathConfirmed)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.9, fill = "gold", alpha = 0.8) +
  xlab("States and Territories") +
  ylab("Number of Deaths") +
  ggtitle("Deaths due to COVID-19 in the United States") +
  labs(caption = paste("Data source: https://covidtracking.com/data/api\nNumber of COVID-19 cases between states and U.S. territories.\nMissing states/territories imply no data.\nData Accessed & Plot created:", current_date)) +
  theme_classic() +
  geom_text(aes(label = deathConfirmed), vjust = -1) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.25, size = 12),
        axis.text.y = element_text(size = 12),
        plot.title = element_text(hjust = 0.5, size = 20),
         plot.caption = element_text(hjust = 0, size = 8)) +
  theme(legend.position = "top")
```

Scatter plot of daily positive case increase versus daily death increase.

```{r, warning = F, message = F}
ggplot(data %>% 
         filter(state != "AS"), aes(positiveIncrease, deathIncrease)) +
  geom_point(size = 5, color = "gold", alpha = 0.6) +
  xlab("Daily Increase in Positive Cases") +
  ylab("Daily Increase in Death Increase") +
  ggtitle("COVID-19 Cases in the United States") +
  labs(caption = paste("Data source: https://covidtracking.com/data/api\nNumber of COVID-19 cases between states and U.S. territories.\nAmerican Samoa was excluded due to no data.\nData Accessed & Plot created:", current_date)) +
  theme_classic() +
  theme(axis.text.x = element_text(vjust = 0.25, size = 8, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 20),
         plot.caption = element_text(hjust = 0, size = 8)) +
  theme(legend.position = "top")


```


Scatterplot above w/o outlier (positive increase > 24,000).
```{r, warning = F, message = F}
ggplot(data %>% 
         filter(state != "AS" & positiveIncrease < 24735), aes(positiveIncrease, deathIncrease)) +
  geom_point(size = 5, color = "gold", alpha = 0.6) +
  xlab("Daily increase in Positive Cases") +
  ylab("Daily Increase in Death") +
  ggtitle("COVID-19 Cases in the United States") +
  labs(caption = paste("Data source: https://covidtracking.com/data/api\nNumber of COVID-19 cases across states and U.S. territories.\nAmerican Samoa was excluded due to no data.\nData Accessed & Plot created:", current_date)) +
  theme_classic() +
  theme(axis.text.x = element_text(vjust = 0.25, size = 8, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 20),
         plot.caption = element_text(hjust = 0, size = 8)) +
  theme(legend.position = "top")
```


# Mapping counts


1. Combine the main data set with the info data set. 

```{r, warning = F, message = F, fig.width = 12, fig.height = 10}


data <- data %>% 
  rename(abbreviation = state)


data <- data %>% 
  left_join(info)

```


# Cases in California example

```{r, warning = F, message = F, fig.width = 12, fig.height = 10}
ca <- read.csv("https://api.covidtracking.com/v1/states/ca/daily.csv")


# make date variables; one for month, year and day

iso <- "([0-9]{4})([0-1][0-9])([0-3][0-9])" # Year-Month-Day to match

dates <- rematch2::re_match(text = ca %>% pull(date), pattern = iso) %>% 
  rename(Year = 1,
         Month = 2,
         Day = 3) %>% 
  unite("Date", c(Year, Month, Day), sep = "-", remove = FALSE)


# Incorporate data to the main data frame.  

```




# Global trends


Prepare a scatter plot animation for multiple countries cases vs deaths.


First read in and wrangle data.

```{r, warning = F, message = F}

coun_res <- GET("https://corona.lmao.ninja/v2/historical?lastdays=100") # read in data

coun_data = fromJSON(rawToChar(coun_res$content)) # Convert json to tabular data

countrylist <- c("USA", "South Africa", "Mexico", "UK", "Brazil", "Italy", "India", "China","Australia") # Countries to analyze

# Index of countries
index <- coun_data %>%
  pull(country) %in% countrylist %>% 
  which()

# Dates to capture (1st and 15th day of each month)

captdate <- c(paste(c(1:12), rep("1/20", times = 12), sep = "/"), # first day of month
           paste(c(1:12), rep("15/20", times = 12), sep = "/")) %>%  # 15th day of month
  mdy()



cases <- coun_data$timeline$cases %>% 
  slice(index) %>% 
  gather() %>% 
  rename(Date = key, Cases = value) %>% 
  mutate(Date = mdy(Date)) %>% 
  filter(Date %in% captdate)
  

deaths <- coun_data$timeline$deaths  %>% 
  slice(index) %>% 
  gather() %>% 
  rename(Date = key, Deaths = value) %>% 
  mutate(Date = mdy(Date)) %>% 
  filter(Date %in% captdate)

recovered <- coun_data$timeline$recovered  %>% 
  slice(index) %>% 
  gather() %>% 
  rename(Date = key, Recovered = value) %>% 
  mutate(Date = mdy(Date)) %>% 
  filter(Date %in% captdate)

total <- cases %>% 
  left_join(deaths, by = "Date") %>% 
  left_join(recovered, by = "Date")


rm(cases, deaths, recovered)

total <- total %>% 
  mutate(Country = rep(coun_data %>%
                         slice(index) %>% 
                         pull(country), times = nrow(total)/length(index)),
         Province = rep(coun_data %>%
                          slice(index) %>% 
                          pull(province), times = nrow(total)/length(index)))

# Collapse to obtain the total of Cases, Deaths and Recovered by Country

total <- total %>% 
  group_by(Country, Date) %>% 
  summarise(Cases = sum(Cases), Deaths = sum(Deaths), Recovered = sum(Recovered))
```


Read in world population data and estimate a per capita per selected country.

```{r, warning = F, message = F}
library(remotes)
library(WDI)

WDIsearch('population, total')

dat = WDI(indicator='SP.POP.TOTL', start = 2019, end=2019) %>% 
  mutate(country = case_when(
    country %in% "United States" ~ "USA",
    country %in% "United Kingdom" ~ "UK",
    TRUE ~ country
  )) %>% 
  janitor::clean_names() %>% 
  filter(country %in% countrylist) %>% 
  rename(Country = country) 
  

# Merge population data

total <- total %>% 
  left_join(dat)

rm(dat)

# Estimate per capita cases, deaths and recovered


capita <- total %>% 
  group_by(Country, Date) %>% 
  summarise(capitaDeaths = Deaths/sp_pop_totl,
            capitaCases = Cases/sp_pop_totl,
            capitaRecovered = Recovered/sp_pop_totl
            )

total <- total %>% 
  left_join(capita)

```

## Data distribution

Summary stats

```{r, warning = F, message = F, fig.width = 12, fig.height = 10}

sum_total <- total %>% 
                ungroup(Date) %>% 
                summarise(across(c(Cases, Deaths, Recovered), mean)) %>% 
                rename_at(vars(-Country),function(x) paste0(x,"_mean")) %>% 
                left_join(
                total %>% 
                  ungroup(Date) %>% 
                  summarise(across(c(Cases, Deaths, Recovered), sd)) %>% 
                  rename_at(vars(-Country),function(x) paste0(x,"_sd"))
                ) %>% 
                select("Country", sort(colnames(.)))

sum_total
```
Per Capita Deaths

```{r, warning = F, message = F, fig.width = 12, fig.height = 10}
ggplot(total) +
  geom_histogram(aes(capitaDeaths, fill = Country),
                 alpha = 0.8,
                 bins = 50) +
  theme_minimal()
```


## Make animation

```{r, warning = F, message = F, fig.width = 12, fig.height = 10}

xlow <- total %>% 
  pull(capitaCases) %>% 
  min()

xhigh <- total %>% 
  pull(capitaCases) %>% 
  max()

ylow <- total %>% 
  pull(capitaDeaths) %>% 
  min()

yhigh <- total %>% 
  pull(capitaDeaths) %>% 
  max()

p <- ggplot(
  total, 
  aes(x = capitaCases, y = capitaDeaths, color = Country)
  ) +
  geom_point(alpha = 0.7, size = 7, position = position_jitter(h=0.15,w=0.15)) +
  ggtitle("COVID Cases & Deaths in Last 100 Days")  +
  scale_color_brewer(palette = "Set3") +
  scale_size(range = c(2, 12)) +
  xlim(xlow, xhigh) +
  ylim(ylow, yhigh) +
  #scale_x_log10() +
  labs(x = "Per Capita Cases", y = "Per Capita Deaths (Log-fold)") +
  geom_text(aes(label = Country), color = "black") +
  theme_classic() +
  theme(axis.text= element_text(size = 20, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 25),
        axis.title = element_text(size = 22)) +
  theme(legend.position = "top")

animation <- p + transition_time(Date) +
  labs(title = "Date: {frame_time}")

animation
```


